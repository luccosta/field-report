CREATE DATABASE FIELD_REPORT;

USE FIELD_REPORT;

CREATE TABLE CLIENTE(
	IDCLIENTE INT PRIMARY KEY AUTO_INCREMENT,
	NOME VARCHAR(200)
);

CREATE TABLE SETOR(
	IDSETOR INT PRIMARY KEY AUTO_INCREMENT,
	NOME VARCHAR(30),
	GERENTE VARCHAR(40),
	NUM_EMPREGADOS INT(4),
	PAVIMENTO INT(3),
	SALA INT(2)
);

CREATE TABLE FUNCIONARIO(
	IDFUNCIONARIO INT PRIMARY KEY AUTO_INCREMENT,
	NOME VARCHAR(50) NOT NULL,
	CPF INT(11) UNIQUE,
	RUA VARCHAR(200),
	CEP INT(8),
	NUM INT(4),
	COMPLEMENTO VARCHAR(200),
	SALARIO INT(4),
	SEXO ENUM('M', 'F'),
	IDADE INT(2),
	CARGA_HORARIA_SEMANAL INT(2),
	INICIO_CONTRATO VARCHAR(10),
	FIM_CONTRATO VARCHAR(10),

	IDF_SETOR INT,
	FOREIGN KEY(IDF_SETOR) REFERENCES SETOR(IDSETOR)
);

CREATE TABLE PROJETO(
	IDPROJETO INT PRIMARY KEY AUTO_INCREMENT,
	DESCRICAO VARCHAR(5000),
	STATUS ENUM('PENDENTE', 'EM ANDAMENTO', 'CONCLUIDO'),
	INICIO VARCHAR(11),
	FIM VARCHAR(11),
	CIDADE VARCHAR(200),
	RUA VARCHAR(200),
	CEP INT(8),
	NUM INT(4),

	IDF_CLIENTE INT,
	FOREIGN KEY(IDF_CLIENTE) REFERENCES CLIENTE(IDCLIENTE)
);

CREATE TABLE RELATORIO(
	IDRELATORIO INT PRIMARY KEY AUTO_INCREMENT,
	PDF BLOB,
	FOTO BLOB,

	IDF_PROJETO INT,
	FOREIGN KEY(IDF_PROJETO) REFERENCES PROJETO(IDPROJETO)
);

# Inserindo valores nas tabelas

INSERT INTO CLIENTE(NOME)
VALUES
('Petrobrás'),
('GNV');

INSERT INTO RELATORIO(PDF, FOTO)
VALUES
(LOAD_FILE('example.pdf'),
LOAD_FILE('example.png'));

INSERT INTO PROJETO(DESCRICAO, STATUS, INICIO, FIM, CIDADE, RUA, CEP, NUM, IDF_CLIENTE)
VALUES
('Vazamento de gas em encanamento', 'CONCLUIDO', '11/08/2021', '14/08/2021', 'São Paulo', 'Casa do Ator', '04546003', '783', (SELECT IDCLIENTE from CLIENTE WHERE NOME='Petrobrás')), 
('Perda de potência', 'CONCLUIDO', '12/07/2021', '14/07/2021', 'Campina Grande', 'Ascendino Moura', '58410127', '100', (SELECT IDCLIENTE from CLIENTE WHERE NOME='GNV'));

INSERT INTO RELATORIO(PDF, FOTO, IDF_PROJETO)
VALUES
(LOAD_FILE('example.pdf'),
LOAD_FILE('example.png'),
(SELECT IDPROJETO from PROJETO WHERE DESCRICAO='Perda de potência')
);

INSERT INTO RELATORIO(PDF, FOTO, IDF_PROJETO)
VALUES
(LOAD_FILE('example.pdf'),
LOAD_FILE('example.png'),
(SELECT IDPROJETO from PROJETO WHERE DESCRICAO='Perda de potência')
);

# Testes secundários

INSERT INTO PROJETO(DESCRICAO, STATUS, INICIO, CIDADE, RUA, CEP, NUM)
VALUES
('Manutenção preventiva', 'EM ANDAMENTO', '11/07/2021', 'São Paulo', 'Olimpiadas', '04546000', '102'), 
('Contador quebrado', 'CONCLUIDO', '10/07/2021', 'Joao Pessoa', 'Palmeiras', '57323910', '100');

INSERT INTO PROJETO(DESCRICAO, STATUS, INICIO, CIDADE, RUA, CEP, NUM)
VALUES
('Manutenção preventiva', 'EM ANDAMENTO', '11/07/2021', 'São Paulo', 'Olimpiadas', '04546000', '102'), 
('Manutenção preventiva', 'EM ANDAMENTO', '10/07/2021', 'Joao Pessoa', 'Palmeiras', '57323910', '100');

INSERT INTO PROJETO(DESCRICAO, STATUS, CIDADE, RUA, CEP, NUM)
VALUES
('Vazamento de óleo', 'PENDENTE', 'Campina Grande', 'Alto Branco', '58410550', '2000');

INSERT INTO SETOR(NOME, GERENTE, NUM_EMPREGADOS, PAVIMENTO, SALA)
VALUES
('Manutenção preventiva', 'Lucas Fernando', 5, 2, 1),
('Resolução de problemas', 'Murilo dos Santos', 8, 2, 2);

INSERT INTO FUNCIONARIO(NOME, CPF, RUA, CEP, NUM, COMPLEMENTO, SALARIO, SEXO, IDADE, CARGA_HORARIA_SEMANAL, INICIO_CONTRATO)
VALUES
('Douglas Dantas', 12155206172, Alvares Cabral, 22022473, 102, 'Apt.142', 6000, 'M', 23, 40, '10/02/2020');

# Consultas

SELECT COUNT(*) AS QUANTIDADE
FROM RELATORIO R
INNER JOIN PROJETO P
ON P.IDPROJETO = R.IDF_PROJETO
WHERE DESCRICAO = 'Perda de potência';

SELECT F.RUA, F.NUM, F.COMPLEMENTO, F.CEP
FROM FUNCIONARIO F
INNER JOIN PROJETO P
ON P.ID_FUNCIONARIO_RESPONSAVEL = F.IDFUNCIONARIO
WHERE NOME = 'Douglas Dantas';

SELECT 
    MAX(SALARIO) Maior_Salario
FROM
    FUNCIONARIO
